name: pr build

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch: { }
jobs:
  quality_gate:
    name: Quality Gate
    uses: ./.github/workflows/quality-gate.yml
    secrets: inherit

  build:
    needs: quality_gate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: 17
          cache: 'gradle'

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Build with Gradle
        run: ./gradlew assembleRelease

      - name: Report APK Size ðŸ“Š
        run: |
          APK_PATH="app/build/outputs/apk/release/app-release-unsigned.apk"
          if [ -f "$APK_PATH" ]; then
            APK_SIZE=$(stat -c%s "$APK_PATH")
            APK_SIZE_MB=$(echo "scale=2; $APK_SIZE / 1024 / 1024" | bc)
            echo "## ðŸ“Š Binary Size Report" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "| :--- | :--- |" >> $GITHUB_STEP_SUMMARY
            echo "| **APK Size** | ${APK_SIZE_MB} MB |" >> $GITHUB_STEP_SUMMARY
            echo "| **Raw Bytes** | ${APK_SIZE} |" >> $GITHUB_STEP_SUMMARY
            # Warn if over budget
            if [ "$APK_SIZE" -gt 104857600 ]; then
              echo "| **Status** | âš ï¸ Over 100MB Budget! |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| **Status** | âœ… Within Budget |" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          path: app/build/outputs/apk/release/app-release-unsigned.apk
